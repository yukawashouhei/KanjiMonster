//
//  MonsterSpriteView.swift
//  KanjiMonster
//
//  Created by 湯川昇平 on 2026/02/21.
//

import SwiftUI

struct MonsterSpriteView: View {
    let monster: Monster
    var isHit: Bool = false
    var isDefeated: Bool = false

    private let gridSize = 8
    private let pixelSize: CGFloat = 10

    var body: some View {
        VStack(spacing: 4) {
            pixelGrid
                .opacity(isDefeated ? 0 : 1)
                .offset(x: isHit ? -5 : 0)
                .animation(
                    isHit ? .default.repeatCount(3, autoreverses: true).speed(4) : .default,
                    value: isHit
                )

            Text(monster.name)
                .pixelFont(12)
                .foregroundStyle(GBColor.light)
        }
    }

    private var pixelGrid: some View {
        let pattern = monsterPattern(for: monster.id)
        return VStack(spacing: 1) {
            ForEach(0..<gridSize, id: \.self) { row in
                HStack(spacing: 1) {
                    ForEach(0..<gridSize, id: \.self) { col in
                        Rectangle()
                            .fill(pixelColor(for: pattern[row][col]))
                            .frame(width: pixelSize, height: pixelSize)
                    }
                }
            }
        }
    }

    private func pixelColor(for value: Int) -> Color {
        switch value {
        case 0: return GBColor.darkest
        case 1: return monster.pixelColor.primary
        case 2: return GBColor.light
        case 3: return GBColor.lightest
        default: return GBColor.darkest
        }
    }

    // swiftlint:disable function_body_length
    private func monsterPattern(for id: Int) -> [[Int]] {
        let patterns: [[[Int]]] = [
            // 1: Slime
            [
                [0,0,0,1,1,0,0,0],
                [0,0,1,2,2,1,0,0],
                [0,1,2,3,3,2,1,0],
                [0,1,2,1,1,2,1,0],
                [1,2,2,2,2,2,2,1],
                [1,2,2,2,2,2,2,1],
                [0,1,2,2,2,2,1,0],
                [0,0,1,1,1,1,0,0],
            ],
            // 2: Moss creature
            [
                [0,0,1,1,1,1,0,0],
                [0,1,2,2,2,2,1,0],
                [1,2,3,2,2,3,2,1],
                [1,2,2,2,2,2,2,1],
                [1,2,1,2,2,1,2,1],
                [0,1,2,2,2,2,1,0],
                [0,1,0,1,1,0,1,0],
                [0,1,0,0,0,0,1,0],
            ],
            // 3: Poison mushroom
            [
                [0,0,0,1,1,0,0,0],
                [0,0,1,2,2,1,0,0],
                [0,1,3,2,3,2,1,0],
                [1,2,2,3,2,2,3,1],
                [1,1,1,1,1,1,1,1],
                [0,0,1,2,2,1,0,0],
                [0,0,1,2,2,1,0,0],
                [0,1,1,1,1,1,1,0],
            ],
            // 4: Bone turtle
            [
                [0,0,1,1,1,1,0,0],
                [0,1,3,3,3,3,1,0],
                [1,3,1,3,3,1,3,1],
                [1,2,2,2,2,2,2,1],
                [1,2,1,2,2,1,2,1],
                [1,2,2,1,1,2,2,1],
                [0,1,2,2,2,2,1,0],
                [0,1,0,1,1,0,1,0],
            ],
            // 5: Dark cat
            [
                [0,1,0,0,0,0,1,0],
                [1,2,1,0,0,1,2,1],
                [1,2,2,1,1,2,2,1],
                [1,3,2,2,2,2,3,1],
                [1,2,1,2,2,1,2,1],
                [0,1,2,2,2,2,1,0],
                [0,0,1,2,2,1,0,0],
                [0,1,0,1,1,0,1,0],
            ],
            // 6: Stone golem
            [
                [0,1,1,1,1,1,1,0],
                [1,2,2,2,2,2,2,1],
                [1,3,1,2,2,1,3,1],
                [1,2,2,2,2,2,2,1],
                [1,2,2,1,1,2,2,1],
                [0,1,2,2,2,2,1,0],
                [1,1,0,1,1,0,1,1],
                [1,0,0,1,1,0,0,1],
            ],
            // 7: Shadow bat
            [
                [1,0,0,0,0,0,0,1],
                [1,1,0,0,0,0,1,1],
                [1,2,1,1,1,1,2,1],
                [1,2,3,2,2,3,2,1],
                [0,1,2,2,2,2,1,0],
                [0,0,1,2,2,1,0,0],
                [0,0,0,1,1,0,0,0],
                [0,0,0,0,0,0,0,0],
            ],
            // 8: Horned bug
            [
                [0,1,0,0,0,0,1,0],
                [0,0,1,0,0,1,0,0],
                [0,1,2,1,1,2,1,0],
                [1,2,3,2,2,3,2,1],
                [1,2,2,2,2,2,2,1],
                [0,1,2,1,1,2,1,0],
                [0,1,0,1,1,0,1,0],
                [1,0,0,0,0,0,0,1],
            ],
            // 9: Dragon man
            [
                [0,1,0,0,0,0,1,0],
                [1,2,1,1,1,1,2,1],
                [0,1,3,2,2,3,1,0],
                [0,1,2,2,2,2,1,0],
                [1,1,2,1,1,2,1,1],
                [0,1,2,2,2,2,1,0],
                [0,1,0,1,1,0,1,0],
                [0,1,0,0,0,0,1,0],
            ],
            // 10: Fire bird
            [
                [0,0,0,1,1,0,0,0],
                [0,0,1,3,3,1,0,0],
                [0,1,3,2,2,3,1,0],
                [1,2,3,1,1,3,2,1],
                [1,2,2,2,2,2,2,1],
                [0,1,2,2,2,2,1,0],
                [1,0,1,0,0,1,0,1],
                [0,0,0,1,1,0,0,0],
            ],
            // 11: Ice wolf
            [
                [0,1,0,0,0,0,1,0],
                [1,3,1,0,0,1,3,1],
                [1,2,2,1,1,2,2,1],
                [0,1,3,2,2,3,1,0],
                [0,1,2,1,1,2,1,0],
                [0,0,1,2,2,1,0,0],
                [0,1,0,1,1,0,1,0],
                [1,0,0,0,0,0,0,1],
            ],
            // 12: Thunder bear
            [
                [0,1,1,0,0,1,1,0],
                [1,2,2,1,1,2,2,1],
                [1,3,2,2,2,2,3,1],
                [1,2,2,2,2,2,2,1],
                [1,2,1,1,1,1,2,1],
                [0,1,2,2,2,2,1,0],
                [0,1,0,1,1,0,1,0],
                [0,1,0,0,0,0,1,0],
            ],
            // 13: Magic warrior
            [
                [0,0,1,1,1,1,0,0],
                [0,1,3,3,3,3,1,0],
                [1,3,1,3,3,1,3,1],
                [0,1,3,3,3,3,1,0],
                [0,1,2,1,1,2,1,0],
                [1,2,2,2,2,2,2,1],
                [0,1,0,1,1,0,1,0],
                [0,1,0,0,0,0,1,0],
            ],
            // 14: Genbu
            [
                [0,0,0,1,1,0,0,0],
                [0,0,1,2,2,1,0,0],
                [0,1,1,1,1,1,1,0],
                [1,2,3,2,2,3,2,1],
                [1,2,2,1,1,2,2,1],
                [1,2,1,2,2,1,2,1],
                [0,1,2,2,2,2,1,0],
                [1,0,1,1,1,1,0,1],
            ],
            // 15: Byakko
            [
                [0,1,0,0,0,0,1,0],
                [1,3,1,1,1,1,3,1],
                [1,2,3,2,2,3,2,1],
                [0,1,2,2,2,2,1,0],
                [0,1,2,1,1,2,1,0],
                [1,2,2,2,2,2,2,1],
                [1,0,1,0,0,1,0,1],
                [1,0,0,0,0,0,0,1],
            ],
            // 16: Suzaku
            [
                [0,0,1,0,0,1,0,0],
                [0,1,3,1,1,3,1,0],
                [1,3,2,3,3,2,3,1],
                [1,2,3,1,1,3,2,1],
                [0,1,2,2,2,2,1,0],
                [1,0,1,2,2,1,0,1],
                [0,0,0,1,1,0,0,0],
                [0,0,1,0,0,1,0,0],
            ],
            // 17: Azure dragon
            [
                [1,0,0,0,0,0,0,1],
                [0,1,0,1,1,0,1,0],
                [0,1,3,2,2,3,1,0],
                [1,2,2,2,2,2,2,1],
                [1,2,3,1,1,3,2,1],
                [0,1,2,2,2,2,1,0],
                [0,0,1,2,2,1,0,0],
                [0,1,1,0,0,1,1,0],
            ],
            // 18: Dark lord
            [
                [0,1,1,1,1,1,1,0],
                [1,3,3,3,3,3,3,1],
                [1,2,1,2,2,1,2,1],
                [1,2,2,1,1,2,2,1],
                [0,1,2,2,2,2,1,0],
                [1,1,2,2,2,2,1,1],
                [1,0,1,0,0,1,0,1],
                [1,0,0,0,0,0,0,1],
            ],
            // 19: Chaos king
            [
                [1,0,1,0,0,1,0,1],
                [0,1,3,1,1,3,1,0],
                [1,3,1,3,3,1,3,1],
                [1,2,3,2,2,3,2,1],
                [1,2,2,1,1,2,2,1],
                [0,1,2,2,2,2,1,0],
                [1,0,1,0,0,1,0,1],
                [1,0,1,0,0,1,0,1],
            ],
            // 20: Final boss
            [
                [1,1,0,1,1,0,1,1],
                [1,3,1,3,3,1,3,1],
                [0,1,3,1,1,3,1,0],
                [1,3,1,3,3,1,3,1],
                [1,2,3,2,2,3,2,1],
                [0,1,2,1,1,2,1,0],
                [0,1,0,1,1,0,1,0],
                [1,1,0,0,0,0,1,1],
            ],
        ]

        let index = (id - 1) % patterns.count
        return patterns[index]
    }
    // swiftlint:enable function_body_length
}

#Preview {
    ScrollView {
        LazyVGrid(columns: [GridItem(.adaptive(minimum: 100))], spacing: 20) {
            ForEach(MonsterData.allMonsters) { monster in
                MonsterSpriteView(monster: monster)
            }
        }
        .padding()
    }
    .gbScreen()
}
